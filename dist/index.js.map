{"version":3,"file":"index.js","mappings":";AAAA;AACA;;;;ACDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["../webpack/runtime/compat",".././lib/main.js"],"sourcesContent":["\nif (typeof __webpack_require__ !== 'undefined') __webpack_require__.ab = new URL('.', import.meta.url).pathname.slice(import.meta.url.match(/^file:\\/\\/\\/\\w:/) ? 1 : 0, -1) + \"/\";","\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    var desc = Object.getOwnPropertyDescriptor(m, k);\n    if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n      desc = { enumerable: true, get: function() { return m[k]; } };\n    }\n    Object.defineProperty(o, k2, desc);\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || (function () {\n    var ownKeys = function(o) {\n        ownKeys = Object.getOwnPropertyNames || function (o) {\n            var ar = [];\n            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;\n            return ar;\n        };\n        return ownKeys(o);\n    };\n    return function (mod) {\n        if (mod && mod.__esModule) return mod;\n        var result = {};\n        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== \"default\") __createBinding(result, mod, k[i]);\n        __setModuleDefault(result, mod);\n        return result;\n    };\n})();\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst core = __importStar(require(\"@actions/core\"));\nconst github = __importStar(require(\"@actions/github\"));\nfunction run() {\n    return __awaiter(this, void 0, void 0, function* () {\n        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k;\n        try {\n            const context = github.context;\n            const github_token = core.getInput('repo-token');\n            const pull_request_number = (_b = (_a = context.payload.pull_request) === null || _a === void 0 ? void 0 : _a.number) !== null && _b !== void 0 ? _b : 0;\n            const pull_request_description = (_d = (_c = context.payload.pull_request) === null || _c === void 0 ? void 0 : _c.body) !== null && _d !== void 0 ? _d : '';\n            const ab_lookup_match = pull_request_description.match(/AB#([^ \\]]+)/g);\n            const repository_owner = (_f = (_e = context.payload.repository) === null || _e === void 0 ? void 0 : _e.owner.login) !== null && _f !== void 0 ? _f : '';\n            const repository_name = (_h = (_g = context.payload.repository) === null || _g === void 0 ? void 0 : _g.name) !== null && _h !== void 0 ? _h : '';\n            const sender_login = (_k = (_j = context.payload.sender) === null || _j === void 0 ? void 0 : _j.login) !== null && _k !== void 0 ? _k : '';\n            let work_item_id = '';\n            let last_comment_posted = { code: \"\", id: 0 };\n            const octokit = github.getOctokit(github_token);\n            console.log(sender_login);\n            // if the sender in the azure-boards bot or dependabot, then exit code\n            // nothing needs to be done\n            if (sender_login === \"dependabot[bot]\") {\n                console.log(`dependabot[bot] sender, exiting action.`);\n                return;\n            }\n            if (context.eventName === 'pull_request') {\n                last_comment_posted = yield getLastComment(octokit, repository_owner, repository_name, pull_request_number);\n                console.log(`Last comment posted by action: ${last_comment_posted.code}`);\n                // check if pull request description contains a AB#<work item number>\n                console.log(`Checking description for AB#{ID} ...`);\n                if (ab_lookup_match) {\n                    for (const match of ab_lookup_match) {\n                        work_item_id = match.substring(3);\n                        break;\n                    }\n                    // Validate work_item_id is a valid integer\n                    if (!/^\\d+$/.test(work_item_id)) {\n                        const errorMsg = `❌ Invalid work item number: AB#${work_item_id}. Work item number must be a valid integer.`;\n                        console.log(errorMsg);\n                        yield octokit.rest.issues.createComment(Object.assign(Object.assign({}, context.repo), { issue_number: pull_request_number, body: `${errorMsg}\\n\\n[Click here](https://learn.microsoft.com/en-us/azure/devops/boards/github/link-to-from-github?view=azure-devops#use-ab-mention-to-link-from-github-to-azure-boards-work-items) to learn more.\\n\\n<!-- code: lcc-416 -->` }));\n                        core.setFailed(errorMsg);\n                        return;\n                    }\n                    console.log(`AB#${work_item_id} found in pull request description.`);\n                    console.log(`Checking to see if bot created link ...`);\n                    // check if the description contains a link to the work item\n                    if ((pull_request_description === null || pull_request_description === void 0 ? void 0 : pull_request_description.includes('[AB#')) && (pull_request_description === null || pull_request_description === void 0 ? void 0 : pull_request_description.includes('/_workitems/edit/'))) {\n                        console.log(`Success: AB#${work_item_id} link found.`);\n                        console.log('Done.');\n                        // if the last comment is the check failed, now it passed and we can post a new comment\n                        if (last_comment_posted.code !== \"lcc-200\" && sender_login === \"azure-boards[bot]\") {\n                            // if the last check failed, then the azure-boards[bot] ran and passed, we can delete the last comment\n                            if (last_comment_posted.code === \"lcc-416\" && sender_login === \"azure-boards[bot]\") {\n                                console.log(`Deleting last comment posted by action: ${last_comment_posted.id}`);\n                                yield octokit.rest.issues.deleteComment({\n                                    owner: repository_owner,\n                                    repo: repository_name,\n                                    comment_id: last_comment_posted.id\n                                });\n                            }\n                            yield octokit.rest.issues.createComment(Object.assign(Object.assign({}, context.repo), { issue_number: pull_request_number, body: `✅ Work item link check complete. Description contains link AB#${work_item_id} to an Azure Boards work item.\\n\\n<!-- code: lcc-200 -->` }));\n                        }\n                        return;\n                    }\n                    else {\n                        // check if the description contains a link to the work item\n                        console.log(`Bot did not create a link from AB#${work_item_id}`);\n                        if (last_comment_posted.code !== \"lcc-416\" && sender_login !== \"azure-boards[bot]\") {\n                            yield octokit.rest.issues.createComment(Object.assign(Object.assign({}, context.repo), { issue_number: pull_request_number, body: `❌ Work item link check failed. Description contains AB#${work_item_id} but the Bot could not link it to an Azure Boards work item.\\n\\n[Click here](https://learn.microsoft.com/en-us/azure/devops/boards/github/link-to-from-github?view=azure-devops#use-ab-mention-to-link-from-github-to-azure-boards-work-items) to learn more.\\n\\n<!--code: lcc-416-->` }));\n                            core.setFailed(`Description contains AB#${work_item_id} but the Bot could not link it to an Azure Boards work item`);\n                            return;\n                        }\n                        core.warning(`Description contains AB#${work_item_id} and waiting for the azure-boards[bot] to validate the link`);\n                    }\n                    return;\n                }\n                else {\n                    if (last_comment_posted.code !== \"lcc-404\") {\n                        yield octokit.rest.issues.createComment(Object.assign(Object.assign({}, context.repo), { issue_number: pull_request_number, body: `❌ Work item link check failed. Description does not contain AB#{ID}.\\n\\n[Click here](https://learn.microsoft.com/en-us/azure/devops/boards/github/link-to-from-github?view=azure-devops#use-ab-mention-to-link-from-github-to-azure-boards-work-items) to Learn more.\\n\\n<!-- code: lcc-404 -->` }));\n                    }\n                    core.setFailed('Description does not contain AB#{ID}');\n                }\n            }\n        }\n        catch (error) {\n            if (error instanceof Error)\n                core.setFailed(error.message);\n        }\n    });\n}\nfunction getLastComment(octokit, repository_owner, repository_name, pull_request_number) {\n    return __awaiter(this, void 0, void 0, function* () {\n        var _a, _b, _c, _d;\n        const last_comment_posted = { code: \"\", id: 0 };\n        // get all comments for the pull request\n        try {\n            const response = yield octokit.rest.issues.listComments({\n                owner: repository_owner,\n                repo: repository_name,\n                issue_number: pull_request_number,\n            });\n            // check for comments\n            if (response.data.length > 0) {\n                const comments = response.data.map((comment) => {\n                    return {\n                        id: comment.id,\n                        created_at: new Date(comment.created_at),\n                        body: comment.body\n                    };\n                });\n                // sort comments by date descending\n                comments.sort((a, b) => {\n                    var _a, _b, _c, _d;\n                    const aTime = (_b = (_a = a.created_at) === null || _a === void 0 ? void 0 : _a.getTime()) !== null && _b !== void 0 ? _b : 0;\n                    const bTime = (_d = (_c = b.created_at) === null || _c === void 0 ? void 0 : _c.getTime()) !== null && _d !== void 0 ? _d : 0;\n                    return bTime - aTime;\n                });\n                // loop through comments and grab the most recent comment posted by this action\n                // we want to use this to check later so we don't post duplicate comments\n                for (const comment of comments) {\n                    last_comment_posted.id = (_a = comment.id) !== null && _a !== void 0 ? _a : 0;\n                    if ((_b = comment.body) === null || _b === void 0 ? void 0 : _b.includes('lcc-404')) {\n                        last_comment_posted.code = \"lcc-404\";\n                        break;\n                    }\n                    if ((_c = comment.body) === null || _c === void 0 ? void 0 : _c.includes('lcc-416')) {\n                        last_comment_posted.code = \"lcc-416\";\n                        break;\n                    }\n                    if ((_d = comment.body) === null || _d === void 0 ? void 0 : _d.includes('lcc-200')) {\n                        last_comment_posted.code = \"lcc-200\";\n                        break;\n                    }\n                }\n            }\n        }\n        catch (error) {\n            console.log(error);\n        }\n        return last_comment_posted;\n    });\n}\nrun();\n"],"names":[],"sourceRoot":""}